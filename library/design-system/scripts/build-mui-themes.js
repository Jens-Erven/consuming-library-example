import { promises as fs } from "node:fs";
import path from "node:path";

const { log, error } = console;

/**
 * Generate Material-UI theme file from design tokens
 * This script automatically creates src/themes/index.ts with all theme configurations
 */
const generateMuiThemes = async () => {
  try {
    log("üé® Generating Material-UI theme file...\n");

    const inputPath = "./design-system/output/tokens-flattened.json";
    const outputPath = "./src/themes/index.ts";
    const outputDir = path.dirname(outputPath);

    // Create the themes directory if it doesn't exist
    try {
      await fs.access(outputDir);
    } catch {
      log(`üìÅ Creating directory: ${outputDir}`);
      await fs.mkdir(outputDir, { recursive: true });
    }

    // Read the flattened themes file
    const rawData = await fs.readFile(inputPath, "utf-8");
    const themes = JSON.parse(rawData);

    // Get theme names (remove 'theme-' prefix)
    const themeNames = Object.keys(themes).map(name => name.replace(/^theme-/, ''));

    log(`üì¶ Found ${themeNames.length} themes: ${themeNames.join(', ')}\n`);

    // Generate the TypeScript file content
    const fileContent = generateThemeFileContent(themeNames);

    // Write the file
    await fs.writeFile(outputPath, fileContent, "utf-8");

    log(`‚úÖ Material-UI theme file generated successfully!`);
    log(`üìÅ Output: ${outputPath}\n`);
    log(`‚ú® The following themes are now available:`);
    themeNames.forEach(theme => {
      log(`   ‚Ä¢ ${theme}LightTheme, ${theme}DarkTheme`);
    });
    log('');

  } catch (err) {
    error("‚ùå An error occurred while generating Material-UI themes:");
    error(err);
    process.exit(1);
  }
};

/**
 * Generate the complete TypeScript file content
 */
function generateThemeFileContent(themeNames) {
  const capitalizeFirst = (str) => str.charAt(0).toUpperCase() + str.slice(1);

  // Generate imports for light themes
  const lightImports = themeNames
    .map(theme => `import * as ${theme}Light from '../../design-system/output/theme-${theme}/light/ts/tokens';`)
    .join('\n');

  // Generate imports for dark themes
  const darkImports = themeNames
    .map(theme => `import * as ${theme}Dark from '../../design-system/output/theme-${theme}/dark/ts/tokens';`)
    .join('\n');

  // Generate individual theme exports
  const themeExports = themeNames
    .map(theme => `export const ${theme}LightTheme = createThemeFromTokens(${theme}Light, 'light');
export const ${theme}DarkTheme = createThemeFromTokens(${theme}Dark, 'dark');`)
    .join('\n');

  // Generate themes object properties
  const themesObjectProps = themeNames
    .map(theme => `  ${theme}: {
    light: ${theme}LightTheme,
    dark: ${theme}DarkTheme,
  },`)
    .join('\n');

  // Generate allThemes object properties
  const allThemesProps = themeNames
    .map(theme => `  '${capitalizeFirst(theme)} Light': ${theme}LightTheme,
  '${capitalizeFirst(theme)} Dark': ${theme}DarkTheme,`)
    .join('\n');

  // Generate ThemeName type
  const themeNameType = themeNames.map(t => `'${t}'`).join(' | ');

  // Generate usage examples for documentation
  const themeOptions = themeNames
    .map(theme => `        <option value="${theme}">${capitalizeFirst(theme)}</option>`)
    .join('\n');

  return `/**
 * Material-UI Theme Configuration
 * 
 * This module provides pre-configured Material-UI themes based on design tokens.
 * It exports themes in multiple formats to support different use cases in consuming applications.
 * 
 * ‚ö†Ô∏è AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 * This file is automatically generated by design-system/scripts/build-mui-themes.js
 * To update, modify design-system/tokens-export.json and run: npm run build
 * 
 * @module themes
 * 
 * USAGE EXAMPLES:
 * 
 * 1. SIMPLE USAGE - Single Static Theme
 * -------------------------------------
 * Import a specific theme and wrap your app with Material-UI's ThemeProvider:
 * 
 * \`\`\`typescript
 * import { ThemeProvider } from '@mui/material/styles';
 * import { ${themeNames[0]}LightTheme } from '@portima/fe-lib';
 * 
 * function App() {
 *   return (
 *     <ThemeProvider theme={${themeNames[0]}LightTheme}>
 *       <YourApp />
 *     </ThemeProvider>
 *   );
 * }
 * \`\`\`
 * 
 * 2. DYNAMIC THEME SWITCHING - Light/Dark Mode
 * ---------------------------------------------
 * Use the structured \`themes\` object to switch between light and dark modes:
 * 
 * \`\`\`typescript
 * import { ThemeProvider } from '@mui/material/styles';
 * import { themes, type ThemeMode } from '@portima/fe-lib';
 * import { useState } from 'react';
 * 
 * function App() {
 *   const [mode, setMode] = useState<ThemeMode>('light');
 *   
 *   return (
 *     <ThemeProvider theme={themes.${themeNames[0]}[mode]}>
 *       <button onClick={() => setMode(mode === 'light' ? 'dark' : 'light')}>
 *         Toggle Mode
 *       </button>
 *       <YourApp />
 *     </ThemeProvider>
 *   );
 * }
 * \`\`\`
 * 
 * 3. FULL THEME SWITCHING - Multiple Themes + Light/Dark
 * -------------------------------------------------------
 * Switch between different theme families (${themeNames.join(', ')}) and modes:
 * 
 * \`\`\`typescript
 * import { ThemeProvider } from '@mui/material/styles';
 * import { themes, type ThemeName, type ThemeMode } from '@portima/fe-lib';
 * import { useState } from 'react';
 * 
 * function App() {
 *   const [themeName, setThemeName] = useState<ThemeName>('${themeNames[0]}');
 *   const [mode, setMode] = useState<ThemeMode>('light');
 *   
 *   return (
 *     <ThemeProvider theme={themes[themeName][mode]}>
 *       <select onChange={(e) => setThemeName(e.target.value as ThemeName)}>
${themeOptions}
 *       </select>
 *       <YourApp />
 *     </ThemeProvider>
 *   );
 * }
 * \`\`\`
 * 
 * 4. ADVANCED - Extending/Customizing Themes
 * -------------------------------------------
 * Import a base theme and extend it with custom overrides:
 * 
 * \`\`\`typescript
 * import { createTheme, ThemeProvider } from '@mui/material/styles';
 * import { ${themeNames[0]}LightTheme } from '@portima/fe-lib';
 * 
 * const customTheme = createTheme(${themeNames[0]}LightTheme, {
 *   components: {
 *     MuiButton: {
 *       styleOverrides: {
 *         root: {
 *           textTransform: 'none',
 *           borderRadius: 8,
 *         },
 *       },
 *     },
 *   },
 *   typography: {
 *     fontFamily: '"Inter", "Roboto", "Helvetica", "Arial", sans-serif',
 *   },
 * });
 * 
 * function App() {
 *   return (
 *     <ThemeProvider theme={customTheme}>
 *       <YourApp />
 *     </ThemeProvider>
 *   );
 * }
 * \`\`\`
 * 
 * 5. WITH APP THEME PROVIDER - Recommended Approach
 * --------------------------------------------------
 * Use the provided AppThemeProvider for automatic localStorage persistence and theme management:
 * 
 * \`\`\`typescript
 * import { AppThemeProvider, useAppTheme } from '@portima/fe-lib';
 * 
 * function App() {
 *   return (
 *     <AppThemeProvider defaultTheme="${themeNames[0]}" defaultMode="light">
 *       <YourApp />
 *     </AppThemeProvider>
 *   );
 * }
 * 
 * // In any component
 * function ThemeControls() {
 *   const { themeName, mode, setTheme, toggleMode } = useAppTheme();
 *   return (
 *     <>
 *       <button onClick={() => setTheme('${themeNames[1] || themeNames[0]}')}>
 *         Switch Theme
 *       </button>
 *       <button onClick={toggleMode}>Toggle Mode</button>
 *     </>
 *   );
 * }
 * \`\`\`
 * 
 * EXPORTS OVERVIEW:
 * 
 * Individual Theme Objects (for simple static usage):
${themeNames.map(t => ` * - ${t}LightTheme, ${t}DarkTheme`).join('\n')}
 * 
 * Structured Themes Object (for dynamic theme switching):
${themeNames.map(t => ` * - themes.${t}.light, themes.${t}.dark`).join('\n')}
 * 
 * Flat Themes Object (for Storybook and dropdown selectors):
${themeNames.map(t => ` * - allThemes['${capitalizeFirst(t)} Light'], allThemes['${capitalizeFirst(t)} Dark']`).join('\n')}
 * 
 * TypeScript Types:
 * - ThemeName: ${themeNameType}
 * - ThemeMode: 'light' | 'dark'
 */

import { createTheme, Theme } from '@mui/material/styles';

// Import light themes
${lightImports}

// Import dark themes
${darkImports}

/**
 * Helper function to create MUI theme from design tokens
 * @param tokens - Design token object
 * @param mode - Theme mode ('light' or 'dark')
 * @returns Material-UI Theme object
 */
const createThemeFromTokens = (tokens: any, mode: 'light' | 'dark'): Theme => {
  return createTheme({
    palette: {
      mode,
      primary: {
        main: tokens.primary,
        contrastText: tokens.primaryContrast,
      },
      secondary: {
        main: tokens.secondary,
        contrastText: tokens.secondaryContrast,
      },
      error: {
        main: tokens.error,
      },
      warning: {
        main: tokens.warning,
      },
      info: {
        main: tokens.info,
      },
      success: {
        main: tokens.success,
      },
      background: {
        default: tokens.backgroundDefault,
        paper: tokens.backgroundPaper,
      },
      text: {
        primary: tokens.textPrimary,
        secondary: tokens.textSecondary,
      },
    },
    spacing: parseInt(tokens.spacingUnit),
    shape: {
      borderRadius: parseInt(tokens.borderRadius),
    },
  });
};

// Export individual theme objects for maximum flexibility
${themeExports}

/**
 * Structured themes object organized by theme name
 * Use this for dynamic theme switching: themes[themeName][mode]
 */
export const themes = {
${themesObjectProps}
};

/**
 * Flat themes object with human-readable names
 * Use this for Storybook or dropdown selectors
 */
export const allThemes = {
${allThemesProps}
};

/**
 * Type representing available theme names
 */
export type ThemeName = ${themeNameType};

/**
 * Type representing theme modes
 */
export type ThemeMode = 'light' | 'dark';
`;
}

// Run the generator
generateMuiThemes();
